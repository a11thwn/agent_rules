# Refactor Skill

## 触发条件
当用户要求重构代码、改善代码质量或消除技术债务时使用此技能。

## 执行步骤

### 1. 代码评估
- 读取目标文件或代码段
- 识别代码坏味道（参考 AGENTS.md 中的 7 种坏味道）
- 评估重构的必要性和风险

### 2. 坏味道识别

| 坏味道 | 检查项 | 严重程度 |
|--------|--------|---------|
| 僵化 | 改动是否牵一发而动全身 | 高/中/低 |
| 冗余 | 是否有重复逻辑 | 高/中/低 |
| 循环依赖 | 模块是否互相缠绕 | 高/中/低 |
| 脆弱性 | 改动一处是否导致其他地方报错 | 高/中/低 |
| 晦涩性 | 代码意图是否明确 | 高/中/低 |
| 数据泥团 | 多个参数是否总是成对出现 | 高/中/低 |
| 不必要的复杂性 | 是否过度设计 | 高/中/低 |

### 3. 重构策略

#### 小步重构
- 每次只重构一个独立的问题
- 保持代码功能不变
- 运行测试验证每一步

#### 安全重构
- 使用 `lsp_goto_definition` 追踪依赖
- 使用 `lsp_find_references` 查找所有引用
- 确保不破坏现有功能

### 4. 常见重构模式

#### 提取函数
- 重复逻辑提取为独立函数
- 长函数拆分为多个小函数
- 复杂条件提取为命名函数

#### 提取变量
- 复杂表达式提取为有意义的变量
- 魔法数字提取为常量
- 重复表达式提取为变量

#### 简化条件
- 嵌套 if 改为 early return
- 复杂条件分解为多个简单条件
- 使用策略模式替代长 switch

#### 优化结构
- 数据泥团封装为对象
- 类职责拆分
- 模块解耦

### 5. 输出格式

```
## 重构报告

### 重构目标
[说明重构的目的和范围]

### 识别的坏味道
1. **坏味道名称**
   - 位置：`path/to/file.ts:XX`
   - 严重程度：高/中/低
   - 描述：[具体问题]

### 重构方案
[说明重构的思路和步骤]

### 改动内容

#### 文件 1：`path/to/file1.ts`

**重构类型**: 提取函数 / 简化条件 / 封装对象

**修改前**:
```typescript
// 原始代码
```

**修改后**:
```typescript
// 重构后的代码
```

#### 文件 2：`path/to/file2.ts`
[如果有多个文件，继续列出]

### 验证结果
- [ ] 所有测试通过
- [ ] 构建成功
- [ ] 无新的诊断错误
- [ ] 代码行数符合约束（≤ 260 行）
- [ ] 目录文件数符合约束（≤ 8 个）

### 改进效果
| 指标 | 重构前 | 重构后 | 改进 |
|------|--------|--------|------|
| 代码行数 | XX | XX | -XX% |
| 函数数量 | XX | XX | +XX% |
| 坏味道数量 | XX | XX | -XX% |
```

### 6. 验证工具
- `lsp_diagnostics` - 检查语法和类型错误
- `bash ./scripts/test.sh` - 运行测试
- `bash ./scripts/build.sh` - 运行构建
- `grep` - 搜索重复代码

## 注意事项
- 重构前确保测试覆盖率足够
- 每次重构后立即运行测试
- 如果测试失败，立即回滚
- 重构不改变功能，只改善结构
- 对于大型重构，先与用户确认方案
